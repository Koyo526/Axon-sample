# =============================================================
# CI ワークフロー: ビルドとテスト
#
# プッシュおよびプルリクエスト時に、コンパイルとテストを実行する。
# =============================================================

name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

permissions:
  contents: read

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    # Gradle Wrapper が axon-level-one/ にあるため、
    # 全ての run ステップの作業ディレクトリをそこに設定する
    defaults:
      run:
        working-directory: axon-level-one

    steps:
      # -------------------------------------------------------
      # 1. ソースコードのチェックアウト
      # -------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------
      # 2. Gradle Wrapper の検証（サプライチェーン攻撃対策）
      #    gradle-wrapper.jar が公式のものかチェックサムで確認する
      # -------------------------------------------------------
      - name: Validate Gradle Wrapper
        uses: gradle/actions/wrapper-validation@v4

      # -------------------------------------------------------
      # 3. JDK 21 のセットアップ
      #    build.gradle.kts の java.toolchain と一致させる
      # -------------------------------------------------------
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      # -------------------------------------------------------
      # 4. Gradle のセットアップ（依存関係キャッシュ含む）
      #    初回以降のビルドを高速化する
      # -------------------------------------------------------
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # -------------------------------------------------------
      # 5. ビルドとテストの実行
      #    build タスクはコンパイル → テスト → JAR 作成を一括実行
      # -------------------------------------------------------
      - name: Build and Test
        run: ./gradlew build
